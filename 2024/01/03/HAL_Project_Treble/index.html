<div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2024-01-03T06:01:22.112Z" title="1/3/2024, 2:01:22 PM">2024-01-03</time>发表</span><span class="level-item"><time dateTime="2024-01-03T06:01:22.112Z" title="1/3/2024, 2:01:22 PM">2024-01-03</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android%E6%8A%80%E6%9C%AF/">Android技术</a></span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">Treble Hal</h1><div class="content"><h1 id="ANDROID-HAL-Project-Treble"><a href="#ANDROID-HAL-Project-Treble" class="headerlink" title="ANDROID HAL- Project Treble"></a>ANDROID HAL- <strong>Project Treble</strong></h1><h2 id="1-HAL至今有四种架构"><a href="#1-HAL至今有四种架构" class="headerlink" title="1. HAL至今有四种架构"></a>1. HAL至今有四种架构</h2><blockquote>
<ul>
<li>Treble Project 之前使用的实现架构,使用传统 HAL 和旧版 HAL</li>
<li>直通式（passthrough mode）：Framework 和 HAL 层工作在同一个进程当中</li>
<li>绑定式（binderized mode）：直通式 HAL binder 化，变为绑定式 HAL。Framework 和 HAL 层工作在不同的进程，之间通过 Binder 进行 IPC</li>
<li>纯绑定式 ：相对于<strong>绑定式</strong>来说，绑定式 HAL 中并不包含直通式 HAL，因此称为纯绑定式</li>
</ul>
</blockquote>
<span id="more"></span>
<p>根据谷歌要求，出厂时就搭载 8.0 的设备，除了谷歌规定的 <a href="mailto:&#97;&#x6e;&#x64;&#x72;&#x6f;&#105;&#x64;&#46;&#x68;&#x61;&#x72;&#x64;&#x77;&#x61;&#x72;&#101;&#x2e;&#x67;&#114;&#97;&#x70;&#x68;&#x69;&#x63;&#x73;&#46;&#x6d;&#x61;&#112;&#x70;&#x65;&#x72;&#x40;&#x31;&#46;&#x30;">&#97;&#x6e;&#x64;&#x72;&#x6f;&#105;&#x64;&#46;&#x68;&#x61;&#x72;&#x64;&#x77;&#x61;&#x72;&#101;&#x2e;&#x67;&#114;&#97;&#x70;&#x68;&#x69;&#x63;&#x73;&#46;&#x6d;&#x61;&#112;&#x70;&#x65;&#x72;&#x40;&#x31;&#46;&#x30;</a> 和 <a href="mailto:&#97;&#x6e;&#100;&#x72;&#x6f;&#105;&#100;&#46;&#x68;&#97;&#x72;&#100;&#x77;&#x61;&#114;&#101;&#x2e;&#114;&#x65;&#110;&#100;&#101;&#x72;&#115;&#x63;&#114;&#105;&#112;&#x74;&#x40;&#49;&#46;&#48;">&#97;&#x6e;&#100;&#x72;&#x6f;&#105;&#100;&#46;&#x68;&#97;&#x72;&#100;&#x77;&#x61;&#114;&#101;&#x2e;&#114;&#x65;&#110;&#100;&#101;&#x72;&#115;&#x63;&#114;&#105;&#112;&#x74;&#x40;&#49;&#46;&#48;</a> 需使用 ②直通模式，其它 HAL 只能采用 绑定式 和 纯绑定式 模式的实现架构。</p>
<hr>
<h2 id="2-绑定式"><a href="#2-绑定式" class="headerlink" title="2. 绑定式"></a>2. 绑定式</h2><ul>
<li><p>绑定式hal 在直通式的基础上，添加 service 进程，修改 transport 类型为 hwbinder</p>
</li>
<li><p>service 的注册使用的是 <a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/hardware/interfaces/+/refs/tags/android-8.1.0_r65/graphics/composer/2.1/default/service.cpp#43">defaultPassthroughServiceImplementation()</a> 方法</p>
</li>
<li><p><code>*-impl.so</code> 库文件通过 <code>HIDL_FETCH_I***</code> 方法来加载传统 HAL(一般硬件厂家提供so共享库)</p>
</li>
<li><p>厂商的实现都在 service 中</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">impl.so:</span><br><span class="line">            cc_library_shared &#123;</span><br><span class="line">                name: &quot;android.hardware.gnss@1.0-impl&quot;,</span><br><span class="line">                    ...</span><br><span class="line">                srcs: [...],</span><br><span class="line">                shared_libs: [...],</span><br><span class="line">            &#125;</span><br><span class="line">service:</span><br><span class="line">            cc_binary &#123;</span><br><span class="line">                name: &quot;android.hardware.gnss@1.0-service&quot;,</span><br><span class="line">                    ...</span><br><span class="line">                srcs: [&quot;service.cpp&quot;],</span><br><span class="line">                shared_libs: [...],</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h2 id="3-纯绑定式"><a href="#3-纯绑定式" class="headerlink" title="3. 纯绑定式"></a>3. 纯绑定式</h2><ul>
<li>service 的注册方法都是 <code>registerAsService()</code>，在 manifest.xml 中的 transport 类型为 hwbinder</li>
<li>**不再单独编译 <code>*-impl.so</code>**，而是全编译进 service 中。</li>
</ul>
   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cc_binary &#123;</span><br><span class="line">    name: &quot;android.hardware.gnss@2.0-service&quot;,</span><br><span class="line">		...</span><br><span class="line">    srcs: [</span><br><span class="line">    	&quot;service.cpp&quot;,</span><br><span class="line">        &quot;GnssConfiguration.cpp&quot;,</span><br><span class="line">		... </span><br><span class="line">    ],</span><br><span class="line">    shared_libs: [...],</span><br><span class="line">    static_libs: [...],</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>参考：</strong> </p>
<p><a target="_blank" rel="noopener" href="https://blog.omitol.com/2018/11/09/android-treble-hidl/">https://blog.omitol.com/2018/11/09/android-treble-hidl/</a></p>
<p><a target="_blank" rel="noopener" href="https://source.android.google.cn/docs/core/architecture/hidl?hl=zh-cn">HIDL  | Android 开源项目  | Android Open Source Project (google.cn)</a></p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Treble Hal</p><p><a href="http://example.com/2024/01/03/HAL_Project_Treble/">http://example.com/2024/01/03/HAL_Project_Treble/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>lx</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2024-01-03</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2024-01-03</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2024/01/04/device.mk/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">android 下device.mk</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2024/01/02/git/"><span class="level-item">GIT</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div class="content" id="valine-thread"></div><script src="//cdn.jsdelivr.net/npm/leancloud-storage@3/dist/av-min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/valine/1.4.16/Valine.min.js"></script><script>new Valine({
            el: '#valine-thread',
            appId: "dB8Dj4QSAc3XtpuM6sS4fCKR-gzGzoHsz",
            appKey: "xrxrySOXhneb2IHjGP1lHSx3",
            
            avatar: "mm",
            avatarForce: false,
            meta: ["nick","mail","link"],
            pageSize: 10,
            lang: "zh-CN",
            visitor: false,
            highlight: true,
            recordIP: false,
            
            
            
            enableQQ: false,
            requiredFields: [],
        });</script></div></div>